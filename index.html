<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Twitter Card æ ‡ç­¾ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="è´¢åŠ¡æ•°æ®ç®¡ç†ç³»ç»Ÿ">
    <meta name="twitter:description" content="ç¦»çº¿æ•°æ®åº“ï¼Œæ•°æ®å®‰å…¨æ— æ‹…å¿§">
    <meta name="twitter:image" content="123.jpg">
    <meta name="twitter:image:alt" content="è´¢åŠ¡æ•°æ®ç»Ÿè®¡">

    <title>è´¢åŠ¡ä»ªè¡¨ç›˜ - é¦–é¡µ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <script src="main.js"></script>
    <script src="plans.js"></script>
    <script src="fireworks.js"></script>
</head>
<!-- çƒŸèŠ±ç”»å¸ƒ -->
<canvas id="fireworksCanvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999999; pointer-events: none;"></canvas>

<body class="hold-transition sidebar-mini">
<div class="wrapper">
    <!-- å¯¼èˆªæ  -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="#" data-widget="pushmenu"><i class="fas fa-bars"></i></a>
            </li>
        </ul>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item mr-3">
                <span class="nav-link" id="currentTime"></span>
            </li>
            <li class="nav-item dropdown mr-3">
                <a class="nav-link" data-toggle="dropdown" href="#" id="planNotification">
                    <i class="fas fa-bell"></i>
                    <span class="badge badge-warning navbar-badge" id="planCount">0</span>
                </a>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                    <span class="dropdown-header">è®¡åˆ’æé†’</span>
                    <div class="dropdown-divider"></div>
                    <div id="planList" style="max-height: 300px; overflow-y: auto;"></div>
                    <div class="dropdown-divider"></div>
                    <a href="plans.html" class="dropdown-item dropdown-footer">æŸ¥çœ‹æ‰€æœ‰è®¡åˆ’</a>
                </div>
            </li>
            <li class="nav-item mr-3">
                <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addPlanModal">
                    <i class="fas fa-plus"></i> æ·»åŠ è®¡åˆ’
                </button>
            </li>
        </ul>
    </nav>

    <!-- ä¾§è¾¹æ  -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <div class="sidebar">
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link active">
                            <i class="nav-icon fas fa-home"></i> é¦–é¡µ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="users.html" class="nav-link">
                            <i class="nav-icon fas fa-users"></i> ç”¨æˆ·ç®¡ç†
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="orders.html" class="nav-link">
                            <i class="nav-icon fas fa-list"></i> è®¢å•è®°å½•
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="plans.html" class="nav-link">
                            <i class="nav-icon fas fa-calendar"></i> è®¡åˆ’ç®¡ç†
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="settings.html" class="nav-link">
                            <i class="nav-icon fas fa-cog"></i> è®¾ç½®
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- å†…å®¹åŒº -->
    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-sm-6">
                        <h1>æ•°æ®çœ‹æ¿</h1>
                    </div>
                    <div class="col-sm-6">
                        <div class="alert alert-warning mb-0 text-right" role="alert">
                            <i class="fas fa-bullhorn mr-2"></i>
                            <strong>å…¬å‘Šï¼š</strong>
                            æœ‰å…¶ä»–åŠŸèƒ½éœ€æ±‚è”ç³»
                            <a href="https://t.me/YiDa_6" target="_blank" class="alert-link">ç›Šè¾¾</a>
                        </div>
                    </div>
                </div>
                <div class="row mb-2 mt-2">
                    <div class="col-sm-2">
                        <div class="input-group">
                            <input type="month" id="monthFilter" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ•°æ®å½•å…¥è¡¨å• -->
        <section class="content">
            <div class="container-fluid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">æ•°æ®å½•å…¥</h3>
                    </div>
                    <div class="card-body">
                        <form id="orderForm">
                            <div class="row data-entry-form">
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>è®¢å•æ—¥æœŸ</label>
                                        <input type="date" id="orderDate" class="form-control" required>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>ç”¨æˆ·å</label>
                                        <input type="text" id="userId" class="form-control" required>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>é‡‘é¢</label>
                                        <input type="number" id="amount" class="form-control" step="0.01" required 
                                               placeholder="å›è½¦é»˜è®¤å……å€¼">
                                    </div>
                                </div>
                                <div class="col-md-3 note-group">
                                    <div class="form-group">
                                        <label>å¤‡æ³¨</label>
                                        <input type="text" id="orderNote" class="form-control" placeholder="å¯é€‰">
                                    </div>
                                </div>
                                <div class="col-md-3 button-group-container">
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <div>
                                            <button type="button" id="depositBtn" class="btn btn-primary">å……å€¼</button>
                                            <button type="button" id="withdrawalBtn" class="btn btn-danger">å‡ºæ¬¾</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="row">
                    <!-- ä»£åŠè®¡åˆ’å¡ç‰‡ -->
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-success" id="todoCard">
                            <div class="inner">
                                <div class="todo-content">
                                    <div class="todo-left">
                                        <h3 id="todoCount">0</h3>
                                        <p>ä»£åŠè®¡åˆ’</p>
                                    </div>
                                    <div class="todo-right">
                                        <div id="todoUser" class="text-sm text-bold"></div>
                                        <div id="todoContent" class="text-sm text-truncate"></div>
                                        <div id="todoTimeLeft" class="text-sm d-flex justify-content-end align-items-center">
                                            <button class="btn btn-sm btn-light d-none" id="confirmBtn" onclick="PlansManager.confirmExpired()">
                                                ç¡®è®¤è¿‡æœŸ
                                            </button>
                                            <span id="timeLeftText"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="icon">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <a href="plans.html" class="small-box-footer">
                                æ›´å¤šä¿¡æ¯ <i class="fas fa-arrow-circle-right"></i>
                            </a>
                        </div>
                    </div>
                    <!-- å½“æœˆç´¯è®¡å……å€¼ -->
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-info">
                            <div class="inner" style="padding-bottom: 34px;">
                                <h3 id="totalDeposit" style="font-size: 2.5rem;">0</h3>
                                <p style="font-size: 1.2rem;">å½“æœˆç´¯è®¡å……å€¼</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-coins"></i>
                            </div>
                        </div>
                    </div>
                    <!-- å½“æœˆç´¯è®¡å‡ºæ¬¾ -->
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-danger">
                            <div class="inner" style="padding-bottom: 34px;">
                                <h3 id="totalWithdrawal" style="font-size: 2.5rem;">0</h3>
                                <p style="font-size: 1.2rem;">å½“æœˆç´¯è®¡å‡ºæ¬¾</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                        </div>
                    </div>
                    <!-- å‡€é¢ -->
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-success">
                            <div class="inner" style="padding-bottom: 34px;">
                                <h3 id="netAmount" style="font-size: 2.5rem;">0</h3>
                                <p style="font-size: 1.2rem;">å‡€é¢</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¶‹åŠ¿å›¾ -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">æœˆåº¦è¶‹åŠ¿å›¾</h3>
                    </div>
                    <div class="card-body">
                        <div id="trendChart"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ·»åŠ  Bug åé¦ˆæŒ‰é’®å’Œå›¾ç‰‡ -->
        <div class="container-fluid mb-4">
            <div class="row align-items-center justify-content-center">
                <div class="col-auto">
                    <a href="https://t.me/YiDa_6" target="_blank" class="btn btn-warning">
                        <i class="fas fa-bug mr-2"></i>æäº¤BUG
                    </a>
                </div>
                <div class="col-auto">
                    <img src="YIDA.jpg" alt="YIDA" style="height: 50px; width: 50px; border-radius: 50%; object-fit: cover;">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢è®¡åˆ’æ¨¡æ€æ¡† -->
<div class="modal fade" id="addPlanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ·»åŠ è®¡åˆ’</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <div class="form-group">
                        <label>ç”¨æˆ·ID</label>
                        <input type="text" class="form-control" id="planUserId" required>
                    </div>
                    <div class="form-group">
                        <label>è®¡åˆ’å†…å®¹</label>
                        <textarea class="form-control" id="planContent" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>è®¡åˆ’æ—¶é—´</label>
                        <input type="datetime-local" class="form-control" id="planTime" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="savePlan">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‚¬æµ®é€šçŸ¥çª—å£ -->
<div id="floatingNotice" class="floating-notice">
    <div class="floating-notice-content">
        <div class="floating-notice-header">
            <h5>ç³»ç»Ÿæ›´æ–°é€šçŸ¥</h5>
            <button type="button" class="close" id="closeNotice">
                <span>&times;</span>
            </button>
        </div>
        <div class="floating-notice-body">
            <p>ğŸ‰ æ–°åŠŸèƒ½ä¸Šçº¿ï¼š</p>
            <ul>
                <li>æ·»åŠ å®¢æˆ·å¤´åƒåŠŸèƒ½</li>
                <li>æ— ç½®é¡¶ï¼Œç½®é¡¶ï¼Œä¼˜å…ˆç½®é¡¶</li>
                <li>å¤‡æ³¨è‡ªåŠ¨è®°å½•å……å€¼/å‡ºæ¬¾ä»¥åŠé‡‘é¢ä¿¡æ¯</li>
                <li>æ·»åŠ å¤‡æ³¨å¿«æ·è¾“å…¥</li>
                <li>ç”¨æˆ·ç®¡ç†é¡µé¢æ·»åŠ æ•°æ®å½•å…¥</li>
                <li>å¯åœ¨è®¾ç½®ä¸­è‡ªå®šä¹‰åŠŸèƒ½å¼€å…³</li>
            </ul>
        </div>
    </div>
</div>
<!-- æ·»åŠ é®ç½©å±‚ -->
<div class="modal-backdrop"></div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡ä½¿ç”¨
        if (!localStorage.getItem('timeZoneNotified')) {
            alert('è¯·å…ˆåˆ°è®¾ç½®é¡µé¢è®¾ç½®æ—¶åŒºï¼é¿å…å½±å“æ•°æ®ç»Ÿè®¡');
            localStorage.setItem('timeZoneNotified', 'true');
        }

        console.log('Initializing database...');
        await initDB();
        console.log('Database initialized successfully');

        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºå½“å‰æœ¬åœ°æ—¶é—´
        const now = new Date();
        document.getElementById('orderDate').value = TimeZoneManager.formatDate(now);
        document.getElementById('monthFilter').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        
        // ä» localStorage è·å–ä¸Šæ¬¡è¾“å…¥çš„ç”¨æˆ·å
        const lastUserId = localStorage.getItem('lastUserId');
        if (lastUserId) {
            document.getElementById('userId').value = lastUserId;
        }

        // ç”¨æˆ·åè¾“å…¥æ¡†ç‚¹å‡»æ—¶æ¸…ç©º
        document.getElementById('userId').addEventListener('focus', function() {
            this.value = '';
        });

        // åˆå§‹åŒ–å›¾è¡¨
        const chart = new ApexCharts(document.querySelector("#trendChart"), {
            chart: { 
                type: 'line',
                height: 400
            },
            stroke: { curve: 'smooth' },
            series: [],
            xaxis: { type: 'datetime' },
            colors: ['#17a2b8', '#dc3545', '#28a745'],
            tooltip: { x: { format: 'dd/MM' } }
        });
        chart.render();

        // åŠ è½½æ•°æ®å‡½æ•°
        const loadData = async () => {
            try {
                const monthStr = document.getElementById('monthFilter').value;
                const [year, month] = monthStr.split('-');
                
                const orders = await getAllOrders();
                console.log('Loaded orders:', orders);
                
                // æ ¹æ®è®¢å•æ—¥æœŸç­›é€‰å½“æœˆè®¢å•ï¼Œè€Œä¸æ˜¯æäº¤æ—¶é—´
                const monthlyOrders = orders.filter(order => {
                    const orderDate = order.orderDate.split('T')[0];  // åªå–æ—¥æœŸéƒ¨åˆ†
                    return orderDate.startsWith(`${year}-${month}`);
                });

                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                const totals = monthlyOrders.reduce((acc, order) => {
                    if (order.type === 'deposit') {
                        acc.deposit += parseFloat(order.amount);
                    } else {
                        acc.withdrawal += parseFloat(order.amount);
                    }
                    return acc;
                }, { deposit: 0, withdrawal: 0 });

                document.getElementById('totalDeposit').textContent = totals.deposit.toFixed(2);
                document.getElementById('totalWithdrawal').textContent = totals.withdrawal.toFixed(2);
                document.getElementById('netAmount').textContent = (totals.deposit - totals.withdrawal).toFixed(2);

                // æ›´æ–°è¶‹åŠ¿å›¾ï¼Œä½¿ç”¨è®¢å•æ—¥æœŸ
                const dailyData = {};
                monthlyOrders.forEach(order => {
                    const day = order.orderDate.split('T')[0];
                    dailyData[day] = dailyData[day] || { deposit: 0, withdrawal: 0 };
                    if (order.type === 'deposit') {
                        dailyData[day].deposit += parseFloat(order.amount);
                    } else {
                        dailyData[day].withdrawal += parseFloat(order.amount);
                    }
                });

                const days = Array.from({length: 31}, (_, i) => {
                    const d = new Date(year, month - 1, i + 1);
                    return TimeZoneManager.formatDate(d);
                }).filter(d => {
                    const [y, m] = d.split('-');
                    return parseInt(m) === parseInt(month);
                });

                chart.updateSeries([{
                    name: 'å……å€¼',
                    data: days.map(d => [new Date(d).getTime(), dailyData[d]?.deposit || 0])
                }, {
                    name: 'å‡ºæ¬¾',
                    data: days.map(d => [new Date(d).getTime(), dailyData[d]?.withdrawal || 0])
                }, {
                    name: 'å‡€é¢',
                    data: days.map(d => [new Date(d).getTime(), 
                        (dailyData[d]?.deposit || 0) - (dailyData[d]?.withdrawal || 0)])
                }]);
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥ï¼š', error);
                alert('åŠ è½½æ•°æ®å¤±è´¥');
            }
        };

        // ç»‘å®šäº‹ä»¶
        document.getElementById('monthFilter').addEventListener('change', loadData);
        
        // å……å€¼æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('depositBtn').addEventListener('click', async () => {
            try {
                const currentTime = TimeZoneManager.getCurrentTime();
                const data = {
                    userId: document.getElementById('userId').value,
                    orderDate: document.getElementById('orderDate').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    type: 'deposit',
                    submitTime: currentTime.toLocaleString('zh-CN'),
                    timeZone: TimeZoneManager.currentTimeZone
                };

                console.log('å……å€¼æ•°æ®:', data);

                if (!data.userId || !data.amount || isNaN(data.amount)) {
                    console.log('æ•°æ®éªŒè¯å¤±è´¥');
                    return;
                }

                // å…ˆè§¦å‘çƒŸèŠ±æ•ˆæœï¼Œä¸ç­‰å¾…æ•°æ®åº“æ“ä½œ
                if (data.amount >= 1000) {
                    console.log('å‡†å¤‡æ˜¾ç¤ºçƒŸèŠ±æ•ˆæœ');
                    showFireworks(data.amount);
                }

                localStorage.setItem('lastUserId', data.userId);
                await addOrder(data);

                // ä½¿ç”¨æ–°çš„å‡½æ•°æ›´æ–°å¤‡æ³¨
                const orderNote = document.getElementById('orderNote').value.trim();
                await updateUserNoteWithTransaction(data.userId, data.amount, 'å……å€¼', orderNote);

                // é‡ç½®è¡¨å•æ—¶ä¿ç•™ç”¨æˆ·å
                const currentUserId = data.userId;
                document.getElementById('orderForm').reset();
                document.getElementById('orderDate').value = TimeZoneManager.formatDate(new Date());
                document.getElementById('userId').value = currentUserId;

                // é‡æ–°åŠ è½½æ•°æ®
                await loadData();
            } catch (error) {
                console.error('æ·»åŠ å¤±è´¥ï¼š', error);
                alert('æ·»åŠ å¤±è´¥ï¼š' + error.message);
            }
        });

        // å‡ºæ¬¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('withdrawalBtn').addEventListener('click', async () => {
            try {
                const currentTime = TimeZoneManager.getCurrentTime();
                const data = {
                    userId: document.getElementById('userId').value,
                    orderDate: document.getElementById('orderDate').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    type: 'withdrawal',
                    submitTime: currentTime.toLocaleString('zh-CN'),
                    timeZone: TimeZoneManager.currentTimeZone
                };

                if (!data.userId || !data.amount || isNaN(data.amount)) {
                    return;
                }

                localStorage.setItem('lastUserId', data.userId);
                await addOrder(data);

                // ä½¿ç”¨æ–°çš„å‡½æ•°æ›´æ–°å¤‡æ³¨
                const orderNote = document.getElementById('orderNote').value.trim();
                await updateUserNoteWithTransaction(data.userId, data.amount, 'å‡ºæ¬¾', orderNote);

                // é‡ç½®è¡¨å•æ—¶ä¿ç•™ç”¨æˆ·å
                const currentUserId = data.userId;
                document.getElementById('orderForm').reset();
                document.getElementById('orderDate').value = TimeZoneManager.formatDate(new Date());
                document.getElementById('userId').value = currentUserId;

                // é‡æ–°åŠ è½½æ•°æ®
                await loadData();
            } catch (error) {
                console.error('æ·»åŠ å¤±è´¥ï¼š', error);
                alert('æ·»åŠ å¤±è´¥ï¼š' + error.message);
            }
        });

        // ä¸ºæ•°æ®å½•å…¥è¡¨å•çš„æ‰€æœ‰è¾“å…¥æ¡†æ·»åŠ å›è½¦äº‹ä»¶
        const orderInputs = ['orderDate', 'userId', 'amount', 'orderNote'];
        orderInputs.forEach(id => {
            document.getElementById(id).addEventListener('keypress', async (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('depositBtn').click();
                }
            });
        });

        // åˆå§‹åŒ–ä»£åŠè®¡åˆ’çŠ¶æ€
        await PlansManager.checkTodoStatus();

        // åˆå§‹åŠ è½½æ•°æ®
        await loadData();
        console.log('Initial data loaded');

        // æ£€æŸ¥å¤‡æ³¨è¾“å…¥æ¡†è®¾ç½®
        const showNoteInput = localStorage.getItem('showNoteInput') !== 'false';
        const noteGroup = document.querySelector('#orderForm .note-group');
        const form = document.querySelector('.data-entry-form');

        if (noteGroup && form) {
            noteGroup.style.display = showNoteInput ? 'block' : 'none';
        }

        // æ£€æŸ¥ç‰ˆæœ¬å¹¶æ˜¾ç¤ºé€šçŸ¥
        await checkVersionAndShowNotice();
    } catch (error) {
        console.error('Initialization error:', error);
        alert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥');
    }
});

// ä¿®æ”¹å……å€¼å’Œå‡ºæ¬¾æŒ‰é’®çš„å¤„ç†é€»è¾‘
const updateUserNoteWithTransaction = async (userId, amount, type, manualNote) => {
    // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è‡ªåŠ¨å¤‡æ³¨
    const autoNoteEnabled = localStorage.getItem('autoNote') !== 'false';
    if (!autoNoteEnabled) {
        // å¦‚æœå…³é—­äº†è‡ªåŠ¨å¤‡æ³¨ï¼Œä½†æœ‰æ‰‹åŠ¨å¤‡æ³¨ï¼Œä»ç„¶éœ€è¦ä¿å­˜æ‰‹åŠ¨å¤‡æ³¨
        if (manualNote) {
            try {
                const user = await getUser(userId);
                const currentDate = new Date().toLocaleDateString();
                const newNote = `${currentDate}: ${manualNote}\n${user?.note || ''}`;
                await updateUserNote(userId, newNote);
            } catch (error) {
                console.error('æ›´æ–°å¤‡æ³¨å¤±è´¥ï¼š', error);
            }
        }
        return;
    }

    try {
        const user = await getUser(userId);
        const currentDate = new Date().toLocaleDateString();
        const autoNote = `${currentDate}: ${amount} ${type}`;
        
        let newNote = '';
        if (manualNote) {
            newNote = `${autoNote} (${manualNote})\n${user?.note || ''}`;
        } else {
            newNote = `${autoNote}\n${user?.note || ''}`;
        }
        
        await updateUserNote(userId, newNote);
    } catch (error) {
        console.error('æ›´æ–°å¤‡æ³¨å¤±è´¥ï¼š', error);
    }
};

// æ£€æŸ¥ç‰ˆæœ¬å¹¶æ˜¾ç¤ºé€šçŸ¥
async function checkVersionAndShowNotice() {
    const currentVersion = '5.0';
    const lastVersion = localStorage.getItem('lastVersion');
    
    console.log('å½“å‰ç‰ˆæœ¬:', currentVersion);
    console.log('ä¸Šæ¬¡ç‰ˆæœ¬:', lastVersion);

    // åªæœ‰å½“ç‰ˆæœ¬ä¸åŒä¸”æœªæ˜¾ç¤ºè¿‡é€šçŸ¥æ—¶æ‰æ˜¾ç¤º
    if (currentVersion !== lastVersion) {
        console.log('ç‰ˆæœ¬ä¸åŒï¼Œæ˜¾ç¤ºé€šçŸ¥');
        
        // æ˜¾ç¤ºé€šçŸ¥
        const notice = document.createElement('div');
        notice.className = 'floating-notice';
        notice.innerHTML = `
            <div class="floating-notice-content">
                <div class="floating-notice-header">
                    <h5>ç³»ç»Ÿæ›´æ–°æç¤º</h5>
                    <button type="button" class="close" onclick="closeNotice(this)">&times;</button>
                </div>
                <div class="floating-notice-body">
                    <p>ç³»ç»Ÿå·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ ${currentVersion}ï¼Œæ›´æ–°å†…å®¹ï¼š</p>
                    <ul>
                        <li>ä¼˜åŒ–äº†æ•°æ®å½•å…¥åŠŸèƒ½</li>
                        <li>æ”¹è¿›äº†ç”¨æˆ·ç•Œé¢ä½“éªŒ</li>
                        <li>æ–°å¢äº†æ•°æ®å¯¼å‡ºåŠŸèƒ½</li>
                        <li>ä¿®å¤äº†å·²çŸ¥é—®é¢˜</li>
                    </ul>
                </div>
            </div>
        `;
        
        // æ·»åŠ é®ç½©å±‚
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop';
        
        document.body.appendChild(notice);
        document.body.appendChild(backdrop);
        
        // ä½¿ç”¨ setTimeout ç¡®ä¿è¿‡æ¸¡æ•ˆæœæ­£å¸¸æ˜¾ç¤º
        setTimeout(() => {
            notice.classList.add('show');
        }, 10);
        
        // ä¿å­˜æ–°ç‰ˆæœ¬å·åˆ° localStorage
        localStorage.setItem('lastVersion', currentVersion);
        console.log('å·²ä¿å­˜æ–°ç‰ˆæœ¬å·');
        
        // æ ‡è®°é€šçŸ¥å·²æ˜¾ç¤º
        localStorage.setItem('noticeShown', 'true');
        console.log('é€šçŸ¥å·²æ˜¾ç¤º');
    }
}

// å…³é—­é€šçŸ¥çš„å‡½æ•°
function closeNotice(button) {
    const notice = button.closest('.floating-notice');
    const backdrop = document.querySelector('.modal-backdrop');
    
    notice.classList.remove('show');
    setTimeout(() => {
        notice.remove();
        backdrop.remove();
    }, 300);
}
</script>
</body>
</html>
